var ENTITY_TRANSACTION="transaction";var ENTITY_PAYEE="payee";var ADMINISTER="administer";var CHARTS="charts";var MAPS="maps";var DEFAULT_PAGE_SIZE=10;var TOTAL_RECORDS="Total Records ";var DEFAULT_ACCOUNT_NAME="Cloud Balance";var init=function(){$(document).bind("ajaxSend",function(){$("#loading").fadeIn()}).bind("ajaxComplete",function(){$("#loading").fadeOut()});showTab(ENTITY_TRANSACTION);$("#tabs a").click(function(e){showTab(e.currentTarget.id)});showUserInformation();$("#datepicker").datepicker({numberOfMonths:2,showButtonPanel:true});$("#amount").blur(function(){$(this).formatCurrency({colorize:true,negativeFormat:"-%s%n",roundToDecimalPlace:2})});showAccountName()};Number.prototype.formatMoney=function(){return accounting.formatMoney(this,{symbol:"$",precision:2,thousand:",",format:{pos:"%s %v",neg:"%s (%v)",zero:"%s  --"}})};var updateAreaChart=function(){var e=function(e){return e.getMonth()+1+"/"+e.getDate().toString()+"/"+e.getFullYear()};var t=function(e){alert(e);$("#areaChart_div").html("<h2>Failed drawing chart</h2>")};var n=function(t){if(t){if(t.data.length==0){return}}if(t){var n="";var r=0;var i=new google.visualization.DataTable;n=t.data;i.addColumn({type:"string",label:"Day"});i.addColumn({type:"number",label:"Balance"});i.addColumn({type:"string",role:"annotation"});i.addColumn({type:"string",role:"tooltip"});var s={};for(var o=0;o<n.length;o++){r+=parseFloat(n[o].amount);s[e(new Date(n[o].date))]=r}var u=0;var a=new Date(Date.now());for(var o=0;o<n.length;o++){if((new Date(n[o].date)).getTime()>=a.getTime()){break}u+=parseFloat(n[o].amount)}var f=new Date(Date.now());f.setDate(f.getDate()-30);var l=new Date(n[0].date);for(var c=new Date;c>=f;c.setDate(c.getDate()-1)){var h=e(c);if(c.getTime()<l.getTime()){u=0;i.addRow([h,u,c.getDate().toString(),u.formatMoney()]);continue}var h=e(c);if(h in s){i.addRow([h,s[h],c.getDate().toString(),s[h].formatMoney()]);u=s[h]}else{i.addRow([h,u,c.getDate().toString(),u.formatMoney()])}}var p={title:"Balance history",titleTextStyle:{color:"black",fontName:"arial",bold:false},hAxis:{title:"Day",titleTextStyle:{color:"#333"}},vAxis:{minValue:0},legend:{position:"none"}};var d=new google.visualization.AreaChart(document.getElementById("areaChartBalanceHistory_div"));d.draw(i,p)}};getData("/"+ENTITY_TRANSACTION,null,n,t,0)};var updateMoneyMap=function(){var e=function(e){alert(e)};var t=function(e){if(e){if(e.data.length==0){return}}if(e){var t="";t=e.data;var n=new google.visualization.DataTable;n.addColumn("string");n.addColumn("string");n.addColumn("number");n.addColumn("number");n.addRow(["All",null,0,0]);n.addRow(["Money in ","All",0,0]);n.addRow(["Money out ","All",0,0]);var r="Money in ";for(var i=0;i<t.length;i++){var s=parseFloat(t[i].total);if(s>0){n.addRow([t[i].name+" "+Math.abs(s).formatMoney(),r,s,i])}}r="Money out ";for(var i=0;i<t.length;i++){var s=parseFloat(t[i].total);if(s<0){n.addRow([t[i].name+" "+Math.abs(s).formatMoney(),r,s*-1,i*-1])}}var o=new google.visualization.TreeMap(document.getElementById("moneyMap_div"));o.draw(n,{minColor:"#f00",midColor:"#ddd",maxColor:"#0d0",headerHeight:15,title:"Money map (all time)",titleTextStyle:{color:"black",fontName:"arial",bold:false,fontSize:14},fontColor:"black",showScale:false})}var u=new google.visualization.DataTable;u.addColumn("string");u.addColumn("string");u.addColumn("number");u.addColumn("number");var a=moment().format("MMMM");u.addRow([a,null,0,0]);var f=0;var l=0;for(var i=0;i<t.length;i++){if(parseFloat(t[i].thisMonth)>0){f=f+parseFloat(t[i].thisMonth)}else{l=l+parseFloat(t[i].thisMonth)}}var c="Money in "+f.formatMoney();var h="Money out "+l.formatMoney();u.addRow([c,a,f,0]);u.addRow([h,a,l,0]);for(var i=0;i<t.length;i++){var s=parseFloat(t[i].thisMonth);if(s>0){u.addRow([t[i].name+" "+Math.abs(s).formatMoney(),c,s,i])}}for(var i=0;i<t.length;i++){var s=parseFloat(t[i].thisMonth);if(s<0){u.addRow([t[i].name+" "+Math.abs(s).formatMoney(),h,s*-1,i*-1])}}var p=new google.visualization.TreeMap(document.getElementById("monthlyMoneyMap_div"));var d=$.datepicker.formatDate("DD MM dd, yy",new Date);p.draw(u,{minColor:"#f00",midColor:"#ddd",maxColor:"#0d0",headerHeight:15,title:"Money map as of "+d,titleTextStyle:{color:"black",fontName:"arial",bold:false,fontSize:14},fontColor:"black",showScale:false})};getData("/"+ENTITY_PAYEE,null,t,e,-1)};var showAccountName=function(){var e=function(e){$("#gc-accountName").html(DEFAULT_ACCOUNT_NAME);var t=e.data[0].accountName;if(t!=null){$("#gc-accountName").html(t)}};var t=function(e){$("#gc-accountName").html("<h2>Failed getting account name</h2>")};getData("/administer",null,e,t,null)};var showUserInformation=function(){var e=function(e){$("#gc-userinformation").hide();$("#gc-userinformation").html(e.data[0].email+' | <a title="Feedback" href="https://code.google.com/p/cloudbalance/issues/list"><i class="fa fa-bug"></i></a> |  <a title="Sign out" href="'+e.data[2].logoutURL+'"><i class="fa fa-sign-out"></i></a>');$("#gc-userinformation").fadeIn()};var t=function(e){$("#gc-userinformation").html("Failed getting user information!")};getData("/user",null,e,t,null)};var showTab=function(e){$(".tab").removeClass("active");$("#"+e).addClass("active");$(".g-unit").hide();$("#"+e+"-tab").show();showHideCreate(e,false);$("#"+e+"-search-reset").click()};var showHideCreate=function(e,t){if(t){$("#"+e+"-search-ctr").hide();$("#"+e+"-list-ctr").hide();$("#"+e+"-create-ctr").show()}else{$("#"+e+"-search-ctr").show();$("#"+e+"-list-ctr").show();$("#"+e+"-create-ctr").hide();populateList(e,null,null)}};var param=function(e,t){this.name=e;this.value=t};var add=function(e){$(".message").hide();$("#"+e+"-reset").click();showHideCreate(e,true);$("span.readonly input").attr("readonly",false);$("select[id$=item-payee-list] > option").remove();if(e==ENTITY_TRANSACTION){populateSelectBox("item-payee-list","/payee");$("input[type=hidden], textarea").val("");var t=new Date;var n=t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear();$("#datepicker").val(n)}};var search=function(e){$(".message").hide();var t=$("form#"+e+"-search-form").serializeArray();var n=new Array;for(var r=0;r<t.length;r++){n[n.length]=new param(t[r].name,t[r].value)}populateList(e,n,null)};var hideMessage=function(e){$("#"+e+"-show-message").hide()};var showMessage=function(e,t){$("#"+t+"-show-message").show().html('<p class="note"><i class="fa fa-info-circle"></i>&nbsp<b>'+e+'</b>&nbsp;<a href="#" onclick=\'hideMessage("'+t+"\")'>Ok</a></p>")};var formValidate=function(e){var t;var n=$("form#"+e+"-create-form").serializeArray();t=n[0].value;switch(e){case ENTITY_TRANSACTION:var r=$("#item-payee-list").val();if(r==""||t==""){showMessage("Payee is required.",e);return}var i=$("#datepicker").val();if(i==""){showMessage("Date is required.",e);return}var s=$("#amount").val();if(s==""){showMessage("Amount is required.",e);return}break;case ENTITY_PAYEE:var o=$("#name").val();if(o==""){showMessage("Payee name is required.",e);return}break;case ADMINISTER:var u=$("#accountName").val();if(u==""){showMessage("Account name is required.",e)}break;default:if(t==""){showMessage("Please check the values in the form.",e);return}break}save(e);$("#"+e+"-show-message").hide()};var save=function(e){switch(e){case ENTITY_TRANSACTION:var t=$("#amount").asNumber();$("#amount").val(t);break;default:break}var n=$("#accountName").val();$("#"+e+"-show-message").hide();var r=new Array;var i=$("form#"+e+"-create-form").serializeArray();for(var s=0;s<i.length;s++){r[r.length]=new param(i[s].name,i[s].value)}r[r.length]=new param("action","PUT");$.ajax({url:"/"+e,type:"POST",data:r,success:function(t){switch(e){case ADMINISTER:$("#gc-accountName").html(n);$("#accountName").val(n);break;default:break}showHideCreate(e,false)},error:function(t){showMessage(t,e)}});$("#"+e+"-reset").click();$("#item-payee-list").reset()};var editEntity=function(entity,id,parent,copy){var parameter=new Array;parameter[parameter.length]=new param("q",id);parameter[parameter.length]=new param("p",parent);var today=new Date;var first=new Date(today.getFullYear(),0,1);var theDayOfYear=Math.round((today-first)/1e3/60/60/24+.5,0);parameter[parameter.length]=new param("dayOfYear",theDayOfYear);parameter[parameter.length]=new param("year",today.getFullYear());$.ajax({url:"/"+entity,type:"GET",data:parameter,success:function(resp){var data=resp.data[0];var formElements=$("form#"+entity+"-create-form :input");for(var i=0;i<formElements.length;i++){if(formElements[i].type!="button"){var ele=$(formElements[i]);if(formElements[i].type=="radio"){continue}if(ele.attr("name")=="payee"){$("select[id$=item-payee-list] > option").remove();ele.append('<option value="'+eval("data."+ele.attr("name"))+'">'+eval("data."+ele.attr("name"))+"</option>")}else{ele.val(eval("data."+ele.attr("name")))}if(copy){if(ele.attr("type")=="hidden"){$(ele).val("")}}}}if(entity==ENTITY_TRANSACTION){var transactionAmount=parseFloat(data.amount);var $radios=$("input:radio[name=transaction-type]");if(transactionAmount>=0){$radios.filter("[value=d]").prop("checked",true)}else{$radios.filter("[value=w]").prop("checked",true);$("#amount").val(transactionAmount*-1)}}showHideCreate(entity,true);$("span.readonly input").attr("readonly",true);$(".formatedNumber").formatCurrency({colorize:false});$(".formatedNumber").removeClass("tableNumber")}})};var edit=function(e,t,n){editEntity(e,t,n,false)};var copy=function(e,t,n){editEntity(e,t,n,true)};var cancel=function(e){$(".message").hide();showHideCreate(e,false)};var deleteEntity=function(e,t,n){$("#dialog-confirm").dialog({resizable:false,height:200,modal:true,buttons:{Delete:function(){var r=new Array;r[r.length]=new param("id",t);r[r.length]=new param("parentid",n);r[r.length]=new param("action","DELETE");$.ajax({url:"/"+e,type:"POST",data:r,dataType:"html",success:function(t){showHideCreate(e,false);if(t!=""){showMessage(t,e)}},error:function(t){showMessage(t,e)}});$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}})};var starEntity=function(e,t,n){var r=new Array;r[r.length]=new param("id",t);r[r.length]=new param("parentid",n);r[r.length]=new param("action","STAR");$.ajax({url:"/"+e,type:"POST",data:r,dataType:"html",success:function(t){showHideCreate(e,false)},error:function(t){showMessage(t,e)}})};var getData=function(e,t,n,r,i){var s=new Date;var o=new Date(s.getFullYear(),0,1);var u=Math.round((s-o)/1e3/60/60/24+.5,0);var a=new Array;if(t!=null){for(var f=0;f<t.length;f++){a[a.length]=t[f]}}a[a.length]=new param("dayOfYear",u);a[a.length]=new param("year",s.getFullYear());a[a.length]=new param("offset",i);$.ajax({url:e,type:"GET",data:a,success:function(e){if(n)n(e)},error:function(e){if(r)r(e)}})};var populateSelectBox=function(e,t){var n=function(t){var n=$("#"+e);n.innerHTML="";var r=t.data;n.append('<option value="">Select</option>');for(var i=0;i<r.length;i++){n.append('<option value="'+r[i].name+'">'+r[i].name+"</option>")}};getData(t,null,n,null,-1)};var populateList=function(e,t,n){if(n==null){n=0}$("#accountName").val(DEFAULT_ACCOUNT_NAME);$("#currentBalance").fadeOut();if(e==CHARTS){updateAreaChart();return}if(e==MAPS){updateMoneyMap();return}var r=function(t){var r="";if(t){r=t.data}var i="";if(r.length>0){switch(e){case ENTITY_TRANSACTION:var s=0;var o;var u=0;var a=0;var f=0;for(var l=0;l<r.length;l++){if(r[l].date.split("/")[0]!=o){u=0;a=0;f=0;o=r[l].date.split("/")[0]}s=s+Number(r[l].amount);r[l].balance=s;r[l].monthlyMoneyIn=u;r[l].monthlyMoneyOut=a;r[l].monthlyCashFlow=f;if(Number(r[l].amount)>0){u=u+Number(r[l].amount);r[l].monthlyMoneyIn=u}else{a=a+Number(r[l].amount);r[l].monthlyMoneyOut=a}f=f+Number(r[l].amount);r[l].monthlyCashFlow=f}var l=r.length;var c;var h;var p;var d=new Date(Date.now());var v;var m;while(l--){transactionDate=new Date(r[l].date);if(transactionDate.getFullYear()==d.getFullYear()){if(transactionDate.getMonth()==d.getMonth()){if(transactionDate.getDate()==d.getDate()){if(!m){m=r[l].balance}}}}if(!m){if(transactionDate.getTime()<d.getTime()){m=r[l].balance}}$("#currentBalance").html(m);$("#currentBalance").fadeIn();i+="<tr>";h=r[l].date.split("/")[0];if(h!=c){var g=$("#"+e+"-list-ctr table thead th").length;i+="<tr>";i+='<td style="background-color:#F5F5F5;" colspan="'+g+'"><div style="float:left">'+moment(r[l].date).format("MMM")+'</div><div class="formatedNumber" style="float: right"> Cash Flow '+r[l].monthlyCashFlow.formatMoney()+"</div></td>";i+="</tr>";c=h}p=r[l].marked=="y"?"fa fa-star":"fa fa-star-o";i+='<td ><i class="'+p+'" style="cursor:pointer;" title="Star me" onclick=\'starEntity("'+e+'","'+r[l].name+'","'+r[l].payee+'")\'"></i></td>';i+="<td>"+moment(r[l].date).format("MMM Do")+"</td><td>"+r[l].payee+"</td><td>"+r[l].memo+'</td><td class="formatedNumber">'+r[l].amount+'</td><td class="formatedNumber">'+r[l].balance+"</td>";i+='<td><a href="#" title="Delete" class="delete-entity" onclick=\'deleteEntity("'+e+'","'+r[l].name+'","'+r[l].payee+'")\'><i class="fa fa-trash-o fa-fw"></i></a> | <a href="#" title="Edit" class="edit-entity" onclick=\'edit("'+e+'","'+r[l].name+'","'+r[l].payee+'")\'><i class="fa fa-pencil fa-fw"></i> </a> | <a href="#" title="Copy" class="edit-entity" onclick=\'copy("'+e+'","'+r[l].name+'","'+r[l].payee+'")\'><i class="fa fa-files-o"></i></a></td>';i+="</tr>"}}var y=0;for(var l=0;l<r.length;l++){switch(e){case ENTITY_PAYEE:i+="<tr>";i+="<td>"+r[l].name+"</td><td>"+r[l].description+'</td><td class="formatedNumber">'+r[l].lastAmount+'</td><td class="formatedNumber">'+r[l].thisMonth+'</td><td class="formatedNumber">'+r[l].lastMonth+'</td><td class="formatedNumber">'+r[l].total+"</td>";i+='<td><a href="#" class="delete-entity" title="Delete" onclick=\'deleteEntity("'+e+'","'+r[l].name+'")\'><i class="fa fa-trash-o fa-fw"></i></a> | <a href="#" class="edit-entity" title="Edit" onclick=\'edit("'+e+'","'+r[l].name+'")\'><i class="fa fa-pencil fa-fw"></i></a></td>';i+="</tr>";break;case ADMINISTER:$("#accountName").val(r[l].accountName);break;default:}}switch(e){case ENTITY_PAYEE:var b=parseInt(t.meta[0].entityCount);$("#"+e+"-list-number-of-records").html(TOTAL_RECORDS+b);var w=b/DEFAULT_PAGE_SIZE;if(w>parseInt(b/DEFAULT_PAGE_SIZE))w=parseInt(w+1);else w=parseInt(w);var E="";for(var S=0;S<w;S++){E+='<a href="#" onclick=\'populateList("'+e+'","'+null+'","'+S*DEFAULT_PAGE_SIZE+"\")'>"+(S+1)+"</a> "}if(b>DEFAULT_PAGE_SIZE){if(n/DEFAULT_PAGE_SIZE!=w-1){E+='<a href="#" onclick=\'populateList("'+e+'","'+null+'","'+(parseInt(n)+DEFAULT_PAGE_SIZE)+"\")'>Next</a>"}else{E+='<a href="#" onclick=\'populateList("'+e+'","'+null+'","'+(w-1)*DEFAULT_PAGE_SIZE+"\")'>Next</a>"}}$("#"+e+"-list-pagination").html("");if(w>1){$("#"+e+"-list-pagination").html(E)}break;default:}}else{var g=$("#"+e+"-list-ctr table thead th").length;i+='<tr><td colspan="'+g+'">You have not entered any '+e+"s yet.</td></tr>";$("#"+e+"-list-number-of-records").html(TOTAL_RECORDS+r.length)}$("#"+e+"-list-tbody").html(i);$(".formatedNumber").formatCurrency({colorize:true});$(".formatedNumber").addClass("tableNumber")};getData("/"+e,t,r,null,n)}